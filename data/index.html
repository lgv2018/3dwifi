<!DOCTYPE html>
<html>
    <head>
      <meta charset="UTF-8">
      <script src="smallfram.js" type="text/javascript"></script>
      <script type="text/javascript">
        var alertdiv;
        var cmds;
        var gcode_n = 0;

        function init() {
          var cmd = $('#cmd');
          var send = $('#send');
          alertdiv = $('#alertdiv');
          cmds = $('#cmds');
          $('.movbtn').foreach(function(i, elem) {
            $(elem).on('click', function() {
              send_gcode('G0 ' + elem.value);
            })
          });
          $('.home').foreach(function(i, elem) {
            $(elem).on('click', function() {
              send_gcode('G28 ' + elem.value);
            })
          });
          $('#send').on('click', function() {
            if (cmd.val().trim() !== '') {
              send_gcode(cmd.val());
              cmd.val('');
            }
          });
          $('#clear').on('click', function() { cmds.html(''); });
          $('#cmd').on('keyup', function(event) { if (event.key == 'Enter') { send.element.click(); }});

          //readOutOfBangMessage();
          // call M110 handshaking
          //send_gcode('M110');
        }

        function readOutOfBangMessage() {
          request('/msg', function(resp) {
            if (resp !== "") {
              add_cmd("Printer message");
              add_resp(resp);
            }
          }, function () {});
          setTimeout(readOutOfBangMessage, 2000);
        }

        function show_alert(message) {
          alertdiv.html(message);
          alertdiv.element.style.display = 'inline';
          setTimeout(function(){ alertdiv.element.style.display = 'none'; }, 5000);
        }

        function ready_state_change(req, onsuccess, onfail) {
          if (req.readyState === 4) {
            if (req.status === 200) {
              onsuccess(req.responseText);
            } else if (!onfail){
              if (req.responseText == '' && req.status == 0)
                show_alert('Timeout.');
              else
                show_alert(req.responseText);
            }
          }
        }

        function request(url, onsuccess, onfail) {
          var req = new XMLHttpRequest();
          req.open("GET", url, true);
          req.onreadystatechange = function() { ready_state_change(req, onsuccess, onfail); };
          req.send();
        }

        function refresh_sd_file_list() {
          send_gcode('M21', function(resp) {
            send_gcode('M20', function(resp) {
              var tbody = $('#sd_files > tbody');
              tbody.html('');
              var files = resp.replace(/\r/g, '').split('\n');
              // first line = Begin file list
              // last 2 lines = End file list \n ok \n
              for (var i = 1; i < files.length - 3; i++) {
                var columns = files[i].split(' ');
                tbody.append(`
                  <tr id='f{0}'>
                    <td class='name'>{1}</td>
                    <td class='size'>{2}</td>
                    <td class='actions'>
                      <button class='ibtn print' value='{0}' onclick='print_file({0});'/>
                      <button class='ibtn trash' value='{0}' onclick='del_file({0});'/>
                    </td>
                  </tr>`.format(i, columns[0], fileSizeSI(parseInt(columns[1]))));
              }
            });
          });
        }

        function upload_sd_file(filename) {
          filename = filename.split(/(\\|\/)/g).pop();
          var formData = new FormData();
          formData.append('filename', filename);
          formData.append('file', $("#sdfile").element.files[0]);

          var prgbar = $("#prgbar").element;
          var req = new XMLHttpRequest();
          req.open("POST", '/sdupload', true);
          req.upload.onprogress = function(evt) {
            if (evt.loaded > 0) {
              prgbar.style.display = 'inline';
              prgbar.value = evt.loaded / evt.total * 100;
            }
            else if (evt.loaded >= evt.total)
              prgbar.style.display = 'none';
          };
          req.onreadystatechange = function() {
            ready_state_change(req, function() {
              refresh_sd_file_list();
              prgbar.style.display = 'none';
            });
          };
          req.send(formData);
        }

        function del_file(id) {
          var file = $("#f" + id).element.firstChild.nextSibling.innerHTML;
          send_gcode('M30 ' + file, function(resp) {
            $("#sd_files").element.deleteRow($("#f" + id).element.rowIndex);
          });
        }

        function print_file(id) {
          var file = $("#f" + id).element.firstChild.nextSibling.innerHTML;
          send_gcode('M23 ' + file, function(resp) { send_gcode('M24'); });
        }

        function add_cmd(cmd) {
          cmds.append('<div class="gc">' + cmd + '</div>');
          cmds.element.scrollTop = cmds.element.scrollHeight;
        }

        function add_resp(resp) {
          var msgs = resp.split('\n').join('<br>');
          cmds.append('<p class="gr">' + msgs + '</p>');
          cmds.element.scrollTop = cmds.element.scrollHeight;
        }

        function send_gcode(cmd, success) {
          //var ncmd = "N{0} {1}".format(gcode_n, cmd);
          //var checksum = [...ncmd].reduce((x,y) => x ^ y.charCodeAt(0), 0);
          //ncmd += "*" + checksum;
          //gcode_n++;
          var ncmd = cmd;
          add_cmd(ncmd);
          request("/gcode?cmd=" + ncmd, function(resp) {
            add_resp(resp);
            if (success) success(resp);
          });
        }
      </script>
      <style>
        * { padding: 5px; margin: 0px; font-family: Verdana, Geneva, sans-serif; font-size: small; }
        div.container { padding: 0px; background-color: #ddd; margin-bottom: 5px; margin-right: 5px; border-radius: 6px; display: inline-grid; }
        div.title { padding: 10px; background-color: #95adf3; font-weight: bold; margin-bottom: 0px; border-radius:  6px 6px 0px 0px; }
        div.cnt { padding: 10px; }
        div.dline { padding: 0px; }
        p { display:  inline-block; }
        table { display: grid; grid-template-areas: "head-fixed" "body-scroll"; padding: 0; border: 1px solid #618685; border-spacing: 0; border-radius: 4px; }
        thead { grid-area: head-fixed; padding: 0; }
        tbody { grid-area: body-scroll; height: 200px; overflow: auto; padding: 0; }
        td.name, th.name { width: 200px; }
        td.size, th.size { width: 80px; text-align: right; }
        td.actions { width: 70px; }
        th.actions { width: 90px; text-align: left; }
        td { padding-bottom: 0; }
        th { font-weight: bold; background-color: #80ced6; border-bottom: 1px solid #618685; }
        th:first-child { border-top-left-radius: 4px; }
        th:last-child { border-top-right-radius: 4px; }
        tr:last-child td:first-child { border-bottom-left-radius: 4px; }
        tr:last-child td:last-child { border-bottom-right-radius: 4px; }
        tr:hover { transition-duration: 0.4s; background-color: #ccc; }
        input[type='range'] { float: left; }
        label { clear: left; text-align: right; width: 70px; display: inline-block; float: left; }
        output { float: left; width: 40px; }
        button {
          border: 1px solid #aaa; background-color: buttonface; display: inline-block; border-radius: 4px;
          transition-duration: 0.4s; min-height: 26px; }
        input[type="file"] { display: none; }
        .customfileinput {
          border: 1px solid #aaa; background-color: buttonface; border-radius: 4px;
          background-image: url(img/upload.svg);
          width: auto; margin-bottom: 5px; }
        .customfileinput:hover { border: 1px solid #618685; background-color: #80ced6; }
        button:hover { border: 1px solid #618685; background-color: #80ced6; }
        button:active { background-color: #60a0b0; }
        .ibtn { background-size: 16px; background-repeat: no-repeat; padding: 5px 5px 5px 21px; background-position-x: 3px;
          background-position-y: center; margin: 0px 5px 5px 0px; height: 14px; }
        .ibtn.home { background-image: url(/img/home.svg); }
        .ibtn.stop { background-image: url(/img/stop.svg); }
        .ibtn.print { background-image: url(/img/print.svg); padding-right: 2px; }
        .ibtn.trash { background-image: url(/img/trash.svg); padding-right: 2px; }
        .ibtn.upload { background-image: url(/img/upload.svg); padding-right: 2px; }
        .ibtn.refresh { background-image: url(/img/refresh.svg); padding-right: 2px; }
        .ibtn.off { background-image: url(/img/power-off.svg); padding-right: 2px; }
        .gc { font-family: monospace; border: 1px solid #aaa; border-left: 3px solid #95adf3; background-color: #eee; margin-bottom: 1px; max-width: 330px; }
        .gr { font-family: monospace; max-width: 330px; }
        #header { min-height: 40px; margin: -10px; margin-bottom: 10px; background-color: #ccc;
          box-shadow: 0px 3px 3px #888; font-size: large;}
        #alertdiv {
          background-color: #eccccc; margin-bottom: 10px; margin-top: -9px;
          box-shadow: 0px 2px 5px #aaa;
          display: none;
          position: fixed;
          width: 100%;
          box-sizing: border-box;
        }
      </style>
    </head>
    <body onload="init()">
      <div id="header"><p style="font-size: larger; font-weight: bold;">3D Printer Wifi Panel</p></div>
      <div id="alertdiv"></div>
      <div class="container">
        <div class="title">Movement</div>
        <div class="cnt">
          <div class="dline">
            <button class="ibtn home">Home all</button>
            <button class="ibtn stop" onclick="send_gcode('M18');">Stop motors</button>
          </div>
          <div class="dline" id="xmov">
            <p>X</p>
            <button class="ibtn home" value="X">Home</button>
            <button class="movbtn" value="X-10">-10</button>
            <button class="movbtn" value="X-1">-1</button>
            <button class="movbtn" value="X-0.1">-0.1</button>
            <button class="movbtn" value="X0.1">0.1</button>
            <button class="movbtn" value="X1">1</button>
            <button class="movbtn" value="X10">10</button>
          </div>
          <div class="dline" id="ymov">
            <p>Y</p>
            <button class="ibtn home" value="Y">Home</button>
            <button class="movbtn" value="Y-10">-10</button>
            <button class="movbtn" value="Y-1">-1</button>
            <button class="movbtn" value="Y-0.1">-0.1</button>
            <button class="movbtn" value="Y0.1">0.1</button>
            <button class="movbtn" value="Y1">1</button>
            <button class="movbtn" value="Y10">10</button>
          </div>
          <div class="dline" id="zmov">
            <p>Z</p>
            <button class="ibtn home" value="Z">Home</button>
            <button class="movbtn" value="Z-10">-10</button>
            <button class="movbtn" value="Z-1">-1</button>
            <button class="movbtn" value="Z-0.1">-0.1</button>
            <button class="movbtn" value="Z0.1">0.1</button>
            <button class="movbtn" value="Z1">1</button>
            <button class="movbtn" value="Z10">10</button>
          </div>
          <div class="dline">
            <datalist id="fansteplist">
              <option>0</option>
              <option>10</option>
              <option>20</option>
              <option>30</option>
              <option>40</option>
              <option>50</option>
              <option>60</option>
              <option>70</option>
              <option>80</option>
              <option>90</option>
              <option>100</option>
            </datalist>
            <datalist id="steplist">
              <option>0</option>
              <option>25</option>
              <option>50</option>
              <option>75</option>
              <option>100</option>
              <option>125</option>
              <option>150</option>
              <option>175</option>
              <option>200</option>
            </datalist>
            <label>Speed:</label>
            <output id="speedout">100%</output>
            <input id="speedin" type="range" step="1" min="0" max="200" value="100" list="steplist"
              oninput="speedout.value = speedin.value + '%'; "
              onchange="send_gcode('M220 S' + speedin.value);"></input>
            <label>Flow:</label>
            <output id="flowout">100%</output>
            <input id="flowin" type="range" step="1" min="0" max="200" value="100" list="steplist"
              oninput="flowout.value = flowin.value + '%';"
              onchange="send_gcode('M221 S' + flowin.value);"></input>
            <label>Fan:</label>
            <output id="fanout">100%</output>
            <input id="fanin" type="range" step="1" min="0" max="100" value="50" list="fansteplist"
              oninput="fanout.value = fanin.value + '%';"
              onchange="send_gcode('M106 S' + Math.trunc(fanin.value/100*255));"></input>
            <button class="ibtn off" style="float: right" onclick="send_gcode('M107');"></button>
          </div>
        </div>
      </div>
      <div class="container">
        <div class="title">Temperature</div>
        <div class="cnt">
        </div>
      </div>
      <div class="container">
        <div class="title">Files</div>
        <div class="cnt">
          <label class="customfileinput ibtn" for="sdfile">Upload to SD</label>
          <input id="sdfile" type="file" name="name" onchange="upload_sd_file(sdfile.value);">
          <progress id="prgbar" style="display: none; width: 60px; float: left; margin-right: 5px; " value="0" max="100"></progress>
          <button id="refresh" class="ibtn refresh" onclick="refresh_sd_file_list();"></button>
          <table id="sd_files">
            <thead>
            </tr><th class='name'>Name</th><th class='size'>Size</th><th class='actions'>Actions</th></tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
      </div>
      <div class="container">
        <div class="title">Commands</div>
        <div class="cnt">
          <div id="cmds" style="overflow: auto; width: 100%; box-sizing: border-box; height: 200px; background-color: white; border: 1px inset; "></div><br/>
          <label>G-code:</label><input id="cmd"></input>
          <button id="send">Send</button>
          <button id="clear">Clear</button>
        </div>
      </div>
      <a href="./upload.html">Upload</a>
  </body>
</html>
